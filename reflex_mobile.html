<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¬ç™ºåŠ›ãƒã‚§ãƒƒã‚«ãƒ¼ (ä¿®æ­£ç‰ˆ)</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    background-color: #ffffff; /* ç™½èƒŒæ™¯ */
    color: #333;
    padding: 10px;
    margin: 0;
  }

  /* è¨­å®šã‚¨ãƒªã‚¢ */
  .settings {
    margin-bottom: 15px;
    background: #f0f0f0;
    padding: 10px;
    border-radius: 8px;
    display: inline-block;
  }
  select { font-size: 1rem; padding: 5px; }

  /* ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ */
  #display-area {
    background-color: #fafafa;
    border: 4px solid #ccc;
    border-radius: 15px;
    height: 300px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 10px auto;
    max-width: 600px;
    position: relative;
  }

  /* å¾…æ©Ÿä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆ */
  #message-text {
    font-size: 2rem;
    font-weight: bold;
    color: #888;
  }

  /* ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ */
  .icon-wrapper {
    display: none; /* JSã§è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ */
    width: 100%;
    height: 100%;
    align-items: center;
    justify-content: center;
  }

  /* SVGã‚¢ã‚¤ã‚³ãƒ³ã®å…±é€šè¨­å®š */
  svg {
    width: 180px;
    height: 180px;
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
  }

  /* æ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆSwitch/Xboxç”¨ï¼‰ */
  .char-icon {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: white;
    border: 8px solid #333;
    color: #333;
    font-size: 80px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* L/Rãƒœã‚¿ãƒ³ */
  .shoulder-icon {
    width: 200px; height: 90px;
    border: 6px solid #333;
    border-radius: 20px;
    font-size: 3rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fff;
  }

  /* ã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼ˆå‰å›ã®ã¾ã¾ã€å°‘ã—è¦‹ã‚„ã™ãèª¿æ•´ï¼‰ */
  .stick-bg {
    width: 150px; height: 150px;
    background: #e0e0e0;
    border-radius: 50%;
    position: relative;
    border: 5px solid #bbb;
  }
  .stick-head {
    width: 90px; height: 90px;
    background: #555;
    border-radius: 50%;
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
  }
  .arrow {
    position: absolute;
    font-size: 60px;
    color: #ff5722; /* æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸ */
    font-weight: bold;
    text-shadow: 2px 2px 0px #fff;
    z-index: 10;
  }

  /* çŠ¶æ…‹ã‚¯ãƒ©ã‚¹ */
  .waiting #message-text { display: block; }
  .waiting .icon-wrapper { display: none; }
  
  .go #message-text { display: none; }
  .go .icon-wrapper { display: flex; }

  .result #message-text { display: block; font-size: 4rem; color: #2e7d32; }
  .result .icon-wrapper { display: none; }

  /* ãã®ä»–UI */
  #status { font-weight: bold; padding: 5px; color: #666; background: #eee; display: inline-block; border-radius: 4px;}
  #score-board { margin: 20px auto; width: 100%; max-width: 600px; border-collapse: collapse; background: #fff; }
  #score-board th, #score-board td { border: 1px solid #ccc; padding: 8px; }
  button { padding: 12px 24px; font-size: 1.2rem; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; margin-top: 10px; }
  button:disabled { background-color: #ccc; }
  .foul { color: red; font-weight: bold; }
</style>
</head>
<body>

  <h1>ğŸ® åå°„ç¥çµŒãƒˆãƒ¬ (SVGç‰ˆ)</h1>
  
  <div class="settings">
    <label>ãƒ¢ãƒ¼ãƒ‰: </label>
    <select id="mode-select">
      <option value="ps">PSã‚¿ã‚¤ãƒ— (Ã—â—‹â–¡â–³)</option>
      <option value="switch">Switchã‚¿ã‚¤ãƒ— (B A Y X)</option>
      <option value="xbox">Xboxã‚¿ã‚¤ãƒ— (A B X Y)</option>
    </select>
  </div>
  <br>

  <div id="status">ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>

  <div id="display-area" class="waiting">
    <div id="message-text">ãƒœã‚¿ãƒ³ã§ã‚¹ã‚¿ãƒ¼ãƒˆ</div>
    <div id="icon-container" class="icon-wrapper"></div>
  </div>

  <button id="startBtn" disabled>è¨ˆæ¸¬ã‚¹ã‚¿ãƒ¼ãƒˆ</button>

  <div style="margin-top:15px;">
    æœ€é«˜è¨˜éŒ²: <span id="best-time" style="color: #ff9800; font-weight: bold; font-size: 1.8rem;">--.---</span>
  </div>

  <table id="score-board">
    <thead><tr><th>No.</th><th>æŒ‡ç¤º</th><th>æ™‚é–“</th><th>åˆ¤å®š</th></tr></thead>
    <tbody id="history-body"></tbody>
  </table>

<script>
  // === å¤‰æ•°å®šç¾© ===
  const displayArea = document.getElementById('display-area');
  const messageText = document.getElementById('message-text');
  const iconContainer = document.getElementById('icon-container');
  const startBtn = document.getElementById('startBtn');
  const statusEl = document.getElementById('status');
  const historyBody = document.getElementById('history-body');
  const bestTimeEl = document.getElementById('best-time');
  const modeSelect = document.getElementById('mode-select');

  let gamepadIndex = null;
  let state = 'IDLE'; 
  let startTime = 0;
  let targetAction = null;
  let measurementTimer = null;
  let bestTime = Infinity;
  let trialCount = 0;
  let currentMode = 'ps';

  modeSelect.addEventListener('change', (e) => { currentMode = e.target.value; });

  // === ã‚²ãƒ¼ãƒ ãƒ‘ãƒƒãƒ‰æ¥ç¶š ===
  window.addEventListener("gamepadconnected", (e) => {
    gamepadIndex = e.gamepad.index;
    statusEl.textContent = `æ¥ç¶šOK: ${e.gamepad.id}`;
    statusEl.style.color = "#2e7d32";
    startBtn.disabled = false;
    loop();
  });
  window.addEventListener("gamepaddisconnected", () => {
    statusEl.textContent = "ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼æœªæ¥ç¶š";
    startBtn.disabled = true;
  });

  function loop() {
    handleInput();
    requestAnimationFrame(loop);
  }

  // === è¡¨ç¤ºç”¨HTMLç”Ÿæˆ (SVGã‚’ä½¿ç”¨) ===
  function getActionHtml(type, index, value) {
    // ã‚¹ãƒ†ã‚£ãƒƒã‚¯
    if(type === 'axis') {
      let arrowChar = '';
      let style = '';
      if(index===1 && value===1) { arrowChar='â†“'; style='top:75%; left:50%; transform:translate(-50%,-50%)'; }
      if(index===1 && value===-1){ arrowChar='â†‘'; style='top:25%; left:50%; transform:translate(-50%,-50%)'; }
      if(index===0 && value===1) { arrowChar='â†’'; style='top:50%; left:75%; transform:translate(-50%,-50%)'; }
      if(index===0 && value===-1){ arrowChar='â†'; style='top:50%; left:25%; transform:translate(-50%,-50%)'; }
      return `<div class="stick-bg"><div class="stick-head"></div><div class="arrow" style="${style}">${arrowChar}</div></div>`;
    }

    // ãƒœã‚¿ãƒ³
    if(type === 'button') {
      // L/Rãƒœã‚¿ãƒ³
      if(index === 4) return `<div class="shoulder-icon">L1 / L</div>`;
      if(index === 5) return `<div class="shoulder-icon">R1 / R</div>`;

      // PSãƒ¢ãƒ¼ãƒ‰ (SVGã§æç”»)
      if(currentMode === 'ps') {
        // Ã— (é’)
        if(index === 0) return `
          <svg viewBox="0 0 100 100">
            <line x1="20" y1="20" x2="80" y2="80" stroke="#5c6bc0" stroke-width="15" stroke-linecap="round" />
            <line x1="80" y1="20" x2="20" y2="80" stroke="#5c6bc0" stroke-width="15" stroke-linecap="round" />
          </svg>`;
        // â—‹ (èµ¤)
        if(index === 1) return `
          <svg viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="35" stroke="#ef5350" stroke-width="15" fill="none" />
          </svg>`;
        // â–¡ (ãƒ”ãƒ³ã‚¯)
        if(index === 2) return `
          <svg viewBox="0 0 100 100">
            <rect x="20" y="20" width="60" height="60" stroke="#ec407a" stroke-width="15" fill="none" rx="5" />
          </svg>`;
        // â–³ (ç·‘)
        if(index === 3) return `
          <svg viewBox="0 0 100 100">
            <polygon points="50,15 85,80 15,80" stroke="#26a69a" stroke-width="15" fill="none" stroke-linejoin="round" />
          </svg>`;
      } 
      // Switch / Xbox ãƒ¢ãƒ¼ãƒ‰ (æ–‡å­—è¡¨ç¤º)
      else {
        let label = '?';
        if(currentMode === 'switch') label = ['B', 'A', 'Y', 'X'][index];
        else label = ['A', 'B', 'X', 'Y'][index]; // Xbox
        return `<div class="char-icon">${label}</div>`;
      }
    }
    return '??';
  }

  // === ãƒ­ã‚¸ãƒƒã‚¯éƒ¨åˆ† ===
  const actions = [
    { type: 'button', index: 0, label: 'South' },
    { type: 'button', index: 1, label: 'East' },
    { type: 'button', index: 2, label: 'West' },
    { type: 'button', index: 3, label: 'North' },
    { type: 'button', index: 4, label: 'L' },
    { type: 'button', index: 5, label: 'R' },
    { type: 'axis', index: 0, val: -1, label: 'Stick â†' },
    { type: 'axis', index: 0, val: 1,  label: 'Stick â†’' },
    { type: 'axis', index: 1, val: -1, label: 'Stick â†‘' },
    { type: 'axis', index: 1, val: 1,  label: 'Stick â†“' },
  ];

  function handleInput() {
    const gp = navigator.getGamepads()[gamepadIndex];
    if (!gp) return;
    
    let inputDetected = false;
    let inputAction = null;

    // ãƒœã‚¿ãƒ³åˆ¤å®š
    for (let i = 0; i < gp.buttons.length; i++) {
      if (gp.buttons[i].pressed) {
        inputDetected = true;
        inputAction = { type: 'button', index: i };
        break; 
      }
    }
    // ã‚¹ãƒ†ã‚£ãƒƒã‚¯åˆ¤å®š
    if (!inputDetected) {
      if (gp.axes[0] < -0.5) inputAction = { type: 'axis', index: 0, val: -1 };
      else if (gp.axes[0] > 0.5) inputAction = { type: 'axis', index: 0, val: 1 };
      else if (gp.axes[1] < -0.5) inputAction = { type: 'axis', index: 1, val: -1 };
      else if (gp.axes[1] > 0.5) inputAction = { type: 'axis', index: 1, val: 1 };
      if (inputAction) inputDetected = true;
    }

    if (state === 'WAITING' && inputDetected) {
      foul("ãŠæ‰‹ã¤ãï¼");
    } else if (state === 'MEASURING' && inputDetected) {
      if (checkInput(inputAction, targetAction)) finishMeasurement();
      else foul("å…¥åŠ›ãƒŸã‚¹ï¼");
    }
  }

  function checkInput(input, target) {
    if (input.type !== target.type) return false;
    if (input.index !== target.index) return false;
    if (input.type === 'axis') return input.val === target.val;
    return true;
  }

  startBtn.addEventListener('click', () => {
    if (state !== 'IDLE' && state !== 'RESULT') return;
    state = 'WAITING';
    displayArea.className = 'waiting';
    messageText.textContent = "å¾…æ©Ÿ...";
    messageText.style.color = "#888";
    startBtn.disabled = true;

    const waitTime = Math.random() * 3000 + 2000;
    measurementTimer = setTimeout(() => {
      targetAction = actions[Math.floor(Math.random() * actions.length)];
      iconContainer.innerHTML = getActionHtml(targetAction.type, targetAction.index, targetAction.val || 0);
      
      state = 'MEASURING';
      displayArea.className = 'go'; // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      startTime = performance.now();
    }, waitTime);
  });

  function finishMeasurement() {
    const duration = (performance.now() - startTime) / 1000;
    state = 'RESULT';
    displayArea.className = 'result';
    messageText.textContent = `${duration.toFixed(3)}ç§’`;
    startBtn.disabled = false;
    if (duration < bestTime) {
      bestTime = duration;
      bestTimeEl.textContent = `${bestTime.toFixed(3)}s`;
    }
    addHistory(getLogLabel(targetAction), `${duration.toFixed(3)}s`, "OK");
  }

  function foul(reason) {
    clearTimeout(measurementTimer);
    state = 'RESULT';
    displayArea.className = 'result';
    messageText.textContent = reason;
    messageText.style.color = "#d32f2f";
    startBtn.disabled = false;
    addHistory(targetAction ? getLogLabel(targetAction) : "---", "---", reason);
  }

  function getLogLabel(act) {
    if(act.type === 'axis') return act.label;
    if(act.type === 'button') {
      const i = act.index;
      if(i===4) return 'Lãƒœã‚¿ãƒ³';
      if(i===5) return 'Rãƒœã‚¿ãƒ³';
      if(currentMode === 'ps') return ['Ã—','â—‹','â–¡','â–³'][i] || 'Btn'+i;
      else if (currentMode === 'switch') return ['B','A','Y','X'][i] || 'Btn'+i;
      else return ['A','B','X','Y'][i] || 'Btn'+i;
    }
    return '?';
  }

  function addHistory(name, time, res) {
    const r = document.createElement('tr');
    r.innerHTML = `<td>${++trialCount}</td><td>${name}</td><td style="font-weight:bold">${time}</td><td class="${res==='OK'?'':'foul'}">${res}</td>`;
    historyBody.insertBefore(r, historyBody.firstChild);
  }
</script>
</body>
</html>