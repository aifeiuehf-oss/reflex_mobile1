<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>RAPID EDGE OMEGA</title>
    <style>
        /* お正月＆ハッカー仕様 */
        body {
            background-color: #050505;
            color: #00FF00;
            font-family: 'Courier New', monospace;
            text-align: center;
            overflow: hidden;
            touch-action: manipulation;
            margin: 0; padding: 0;
        }
        h1 { font-size: 20px; text-shadow: 0 0 10px #00FF00; margin-top: 10px; }
        
        .screen { display: none; height: 100vh; width: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }

        .menu-btn {
            background: #111; color: #00FF00; border: 2px solid #00FF00;
            padding: 15px 30px; margin: 10px; font-size: 18px; cursor: pointer;
            width: 80%; max-width: 300px; border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,255,0,0.3);
            text-transform: uppercase;
        }
        .menu-btn:active { background: #00FF00; color: black; }

        #score { font-size: 90px; font-weight: bold; margin: 10px 0; }
        #timer { font-size: 24px; color: yellow; }
        #instruction { font-size: 14px; color: cyan; margin-bottom: 20px; min-height: 24px;}
        
        /* インジケーター（光る玉） */
        .btn-indicators { display: flex; gap: 15px; margin-bottom: 20px; }
        .indicator {
            width: 50px; height: 50px; border: 2px solid #333; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: #555;
            font-weight: bold; font-size: 20px; transition: all 0.1s;
        }
        /* 正解のターゲット */
        .indicator.target { 
            border-color: yellow; color: yellow; 
            box-shadow: 0 0 10px yellow; transform: scale(1.1);
        }
        /* 押した瞬間の光 */
        .indicator.lit { 
            background: #00FF00; color: black; border-color: #00FF00; 
            box-shadow: 0 0 20px #00FF00; transform: scale(1.2);
        }

        .config-row { margin: 8px; border: 1px solid #333; padding: 10px; width: 85%; font-size: 14px;}
        .waiting { color: yellow; animation: blink 0.5s infinite; }
        
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>
<a href="index.html" style="font-size:20px; color:blue;">反応速度測定アプリに移動</a>
    <div id="screen-menu" class="screen active">
        <h1>RAPID EDGE <span style="color:cyan">OMEGA</span></h1>
        <p style="color:#888; font-size:12px">NEW YEAR EDITION</p>
        
        <button class="menu-btn" onclick="goToGame('single')">SINGLE (1 Btn)</button>
        <button class="menu-btn" onclick="goToGame('dual')">DUAL (交互押し)</button>
        <button class="menu-btn" onclick="goToGame('order')">ORDER (順番押し)</button>
        <br>
        <button class="menu-btn" style="border-color:#888; color:#888" onclick="goToConfig()">[ KEY CONFIG ]</button>
        <div id="status-bar" style="margin-top:20px; font-size:12px; color:#555">DETECTING CONTROLLER...</div>
    </div>

    <div id="screen-game" class="screen">
        <div id="timer">READY</div>
        <div id="score">0</div>
        <div id="instruction">...</div>
        
        <div class="btn-indicators" id="game-indicators"></div>

        <button class="menu-btn" onclick="backToMenu()" style="margin-top:40px; border-color:red; color:red; font-size:14px">EXIT</button>
    </div>

    <div id="screen-result" class="screen">
        <h1 style="font-size:30px">TIME UP!</h1>
        <div id="final-score" style="font-size:80px; color:white">0</div>
        <div id="rank" style="font-size:24px; color:cyan; margin:10px">RANK: CALC...</div>
        <div style="color:yellow; margin-top:30px; font-size:14px" id="retry-msg">PUSH [RESET] TO RETURN</div>
    </div>

    <div id="screen-config" class="screen">
        <h2>KEY CONFIG</h2>
        <div class="config-row" id="cfg-btn1" onclick="startBinding(0)">BUTTON 1: <span class="val">NOT SET</span></div>
        <div class="config-row" id="cfg-btn2" onclick="startBinding(1)">BUTTON 2: <span class="val">NOT SET</span></div>
        <div class="config-row" id="cfg-btn3" onclick="startBinding(2)">BUTTON 3: <span class="val">NOT SET</span></div>
        <div class="config-row" id="cfg-reset" onclick="startBinding(3)" style="border-color:cyan">RESET KEY: <span class="val">NOT SET</span></div>
        <button class="menu-btn" onclick="backToMenu()">SAVE & BACK</button>
    </div>

    <script>
        // ボタン設定 (デフォルト: ×, 〇, □, R2あたり)
        let keyMap = [0, 1, 2, 0]; 
        
        let currentMode = 'single';
        let gameState = 'menu';
        let count = 0;
        let timeLeft = 10.00;
        let isRunning = false;
        let timerId = null;
        
        // 判定用変数
        let orderIndex = 0;         // ORDER用: 次に押すべき場所 (0, 1, 2)
        let lastDualBtnIndex = -1;  // DUAL用: 最後に押したボタンの場所 (0 or 1)
        let wasPressed = [false, false, false, false]; 

        // Config用
        let isBinding = false;
        let bindingTarget = -1;

        // ループ
        function loop() {
            const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
            let gp = null;
            for(let g of gamepads) { if(g && g.buttons) { gp = g; break; } }

            const status = document.getElementById('status-bar');
            if(gp) status.innerText = "CONNECTED: " + gp.id;
            else   status.innerText = "CONNECT CONTROLLER...";

            if(gp) {
                if(gameState === 'config' && isBinding) {
                    for(let i=0; i<gp.buttons.length; i++) {
                        if(gp.buttons[i].pressed) { setKeyBinding(i); break; }
                    }
                }
                else if(gameState === 'game') {
                    handleGameInput(gp);
                }
                else if(gameState === 'result') {
                    // リセットボタンで戻る
                    if(gp.buttons[keyMap[3]] && gp.buttons[keyMap[3]].pressed) {
                        backToMenu();
                    }
                }
            }
            requestAnimationFrame(loop);
        }
        loop();

        // --- 入力判定の心臓部 ---
        function handleGameInput(gp) {
            let targets = [];
            if(currentMode === 'single') targets = [0];
            if(currentMode === 'dual')   targets = [0, 1];
            if(currentMode === 'order')  targets = [0, 1, 2];

            // ORDERモードなら、ターゲット（次に押すべきボタン）を黄色く光らせる
            if(currentMode === 'order') updateIndicators(orderIndex);
            
            // DUALモードなら、次に押すべきボタン（前回と違う方）を黄色く光らせる
            if(currentMode === 'dual') {
                // まだ押してないなら両方ターゲット、押したら違う方がターゲット
                let nextTarget = (lastDualBtnIndex === 0) ? 1 : 0;
                if(lastDualBtnIndex === -1) {
                    // 最初は両方OK
                    document.getElementById('ind-0').classList.add('target');
                    document.getElementById('ind-1').classList.add('target');
                } else {
                    updateIndicators(nextTarget);
                }
            }

            for(let i=0; i<targets.length; i++) {
                let mapIdx = targets[i];
                let actualBtn = keyMap[mapIdx];
                let btnObj = gp.buttons[actualBtn];
                
                if(!btnObj) continue;

                if(btnObj.pressed) {
                    if(!wasPressed[i]) {
                        onPress(i); // 押した瞬間！
                        wasPressed[i] = true;
                    }
                } else {
                    wasPressed[i] = false;
                }
            }
        }

        function onPress(btnIndex) {
            if(!isRunning && timeLeft === 10.00) startGame();
            if(!isRunning) return;

            let validHit = false;

            // --- 判定ロジック ---
            if(currentMode === 'single') {
                validHit = true; 
            } 
            else if(currentMode === 'dual') {
                // 【重要】前回と同じボタンなら無効！ (交互押し強制)
                if(btnIndex !== lastDualBtnIndex) {
                    validHit = true;
                    lastDualBtnIndex = btnIndex; // 記録更新
                }
            }
            else if(currentMode === 'order') {
                // 【重要】順番通りじゃなければ無効！
                if(btnIndex === orderIndex) {
                    validHit = true;
                    orderIndex++;
                    if(orderIndex >= 3) orderIndex = 0; // ループ
                }
            }

            // 正解だった場合のみカウント
            if(validHit) {
                count++;
                document.getElementById('score').innerText = count;
                
                // 光る演出
                let el = document.getElementById('ind-' + btnIndex);
                if(el) {
                    el.classList.add('lit');
                    setTimeout(()=>el.classList.remove('lit'), 100);
                }
                if(navigator.vibrate) navigator.vibrate(10);
            }
        }

        function startGame() {
            isRunning = true;
            document.getElementById('timer').style.color = "white";
            document.getElementById('instruction').innerText = "GO !!!";
            
            timerId = setInterval(() => {
                timeLeft -= 0.01;
                document.getElementById('timer').innerText = timeLeft.toFixed(2);
                if(timeLeft <= 0) endGame();
            }, 10);
        }

        function endGame() {
            isRunning = false;
            clearInterval(timerId);
            timeLeft = 10.00;
            
            document.getElementById('final-score').innerText = count;
            let rank = "B";
            // 難易度ごとにランク基準を変える？とりあえず一律
            if(count >= 70) rank = "SSS (GOD)";
            else if(count >= 60) rank = "SS (MASTER)";
            else if(count >= 40) rank = "S (PRO)"; // 交互押しは難しいので少し甘く
            else rank = "A (GOOD)";
            
            document.getElementById('rank').innerText = "RANK: " + rank;
            document.getElementById('retry-msg').innerText = "PUSH [RESET KEY] TO RETURN";
            
            switchScreen('screen-result');
            gameState = 'result';
        }

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goToGame(mode) {
            currentMode = mode;
            gameState = 'game';
            count = 0;
            orderIndex = 0;
            lastDualBtnIndex = -1; // リセット
            timeLeft = 10.00;
            document.getElementById('score').innerText = "0";
            document.getElementById('timer').innerText = "READY";
            
            let parent = document.getElementById('game-indicators');
            parent.innerHTML = "";
            let num = (mode==='single')?1 : (mode==='dual')?2 : 3;
            
            let msg = "";
            if(mode==='single') msg = "1つのボタンを連打せよ";
            if(mode==='dual')   msg = "2つのボタンを交互に連打せよ";
            if(mode==='order')  msg = "光るボタンを順番に押せ";
            document.getElementById('instruction').innerText = msg;

            for(let i=0; i<num; i++) {
                let div = document.createElement('div');
                div.className = 'indicator';
                div.id = 'ind-' + i;
                div.innerText = i+1;
                parent.appendChild(div);
            }
            // 初期ターゲット表示
            if(mode === 'order') updateIndicators(0);
            if(mode === 'dual') {
                 // DUALは最初両方光らせておきたいが、updateIndicatorsは単一指定なのでCSSクラスで対応
                 // loop内で処理しています
            }

            switchScreen('screen-game');
        }

        function updateIndicators(targetIdx) {
            for(let i=0; i<3; i++) {
                let el = document.getElementById('ind-'+i);
                if(el) {
                    if(i === targetIdx) el.classList.add('target');
                    else el.classList.remove('target');
                }
            }
        }

        function backToMenu() {
            clearInterval(timerId);
            gameState = 'menu';
            switchScreen('screen-menu');
        }

        function goToConfig() {
            gameState = 'config';
            switchScreen('screen-config');
            updateConfigUI();
        }

        function startBinding(targetIdx) {
            isBinding = true;
            bindingTarget = targetIdx;
            let ids = ['cfg-btn1', 'cfg-btn2', 'cfg-btn3', 'cfg-reset'];
            document.getElementById(ids[targetIdx]).querySelector('.val').innerHTML = "<span class='waiting'>PUSH BUTTON...</span>";
        }

        function setKeyBinding(btnCode) {
            isBinding = false;
            keyMap[bindingTarget] = btnCode;
            updateConfigUI();
            setTimeout(() => { bindingTarget = -1; }, 200);
        }

        function updateConfigUI() {
            let ids = ['cfg-btn1', 'cfg-btn2', 'cfg-btn3', 'cfg-reset'];
            for(let i=0; i<4; i++) {
                let el = document.getElementById(ids[i]).querySelector('.val');
                el.innerText = "BTN ID: " + keyMap[i];
                el.style.color = "#00FF00";
            }
        }
    </script>
</body>
</html>

